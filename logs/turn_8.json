{
  "turn": 8,
  "player_choice": null,
  "projected_state": {
    "turn": 7,
    "world": {
      "stability": 62,
      "resources": 58,
      "threat_level": "volatile"
    },
    "metrics": {
      "order": 60,
      "morale": 62,
      "resources": 58,
      "knowledge": 54,
      "glitch": 42
    },
    "nearby_grid": [
      {
        "id": "player",
        "x": 4,
        "y": 4,
        "room": "courtyard",
        "hostile": false,
        "entity_type": "player"
      },
      {
        "id": "marshal_edda",
        "x": 4,
        "y": 3,
        "room": "courtyard",
        "hostile": false,
        "entity_type": "npc"
      },
      {
        "id": "scout_rhea",
        "x": 2,
        "y": 5,
        "room": "yard",
        "hostile": false,
        "entity_type": "npc"
      },
      {
        "id": "quartermaster_boris",
        "x": 6,
        "y": 2,
        "room": "yard",
        "hostile": false,
        "entity_type": "npc"
      }
    ],
    "npc_focus": [
      {
        "id": "marshal_edda",
        "name": "Marshal Edda Vayne",
        "room": "courtyard",
        "role": "commander",
        "stance": null,
        "hostile": false
      }
    ],
    "recent_events": [
      "Flag 'planner_lock_auto_lock' enabled.",
      "knowledge adjusted by 1. Cause: planner:investigate.",
      "Flag 'planner_lock_auto_lock' enabled.",
      "knowledge adjusted by 1. Cause: planner:escalate.",
      "Flag 'planner_lock_auto_lock' enabled."
    ],
    "flags": [
      "planner_lock_auto_lock"
    ]
  },
  "director_output": {
    "scene_intent": {
      "focus": "escalate",
      "turn": 7,
      "player_choice": null,
      "risk_budget": 3,
      "summary": "Turn 7 directive: escalate.",
      "notes": "Threat peak (42.1). Event cue: fire_breakout. Endgame directive active.",
      "threat_phase": "peak",
      "event_seed": "fire_breakout",
      "threat_score": 42.13,
      "final_directive": {
        "final_trigger": true,
        "reason": "Reached final graph node: last_defense",
        "recommended_path": "desperate"
      }
    },
    "player_options": [
      {
        "id": "heroic_choice",
        "label": "Fallback to the desperate lifeline",
        "text": "Rally the last vanguard for a heroic stand even if the odds are fatal.",
        "type": "offense"
      },
      {
        "id": "desperate_fallback",
        "label": "Desperate fallback corridor",
        "text": "Shepherd civilians and healers through the final escape tunnels.",
        "type": "logistics"
      }
    ]
  },
  "planner_output": {
    "prompt": "You are a deterministic planner focused on safe function calls.\nRespond with JSON that satisfies PLAN_FORMAT. Hard JSON rules:\n- Max 2 calls; no $schema fields; JSON only; no explanations.\nSadece JSON döndür; açıklama yazma; en fazla 2 fonksiyon çağır.\nCRITICAL CONSTRAINTS:\n- Max 2 calls in the calls array.\n- No $schema field anywhere in your response.\n- Only JSON output. No markdown, no code fences.\nPLANNING RULES:\n1) Aşağıdaki kategorilerden en fazla 2 fonksiyon çağır.\n2) Sadece AVAILABLE_FUNCTIONS'teki isimleri kullan.\n3) NPC pozisyonu, duvar ve tehdit durumuna göre parametre seç.\nPROJECTED_STATE:\n{\"turn\": 7, \"world\": {\"stability\": 62, \"resources\": 58, \"threat_level\": \"volatile\"}, \"metrics\": {\"order\": 60, \"morale\": 62, \"resources\": 58, \"knowledge\": 54, \"glitch\": 42}, \"nearby_grid\": [{\"id\": \"player\", \"x\": 4, \"y\": 4, \"room\": \"courtyard\", \"hostile\": false, \"entity_type\": \"player\"}, {\"id\": \"marshal_edda\", \"x\": 4, \"y\": 3, \"room\": \"courtyard\", \"hostile\": false, \"entity_type\": \"npc\"}, {\"id\": \"scout_rhea\", \"x\": 2, \"y\": 5, \"room\": \"yard\", \"hostile\": false, \"entity_type\": \"npc\"}, {\"id\": \"quartermaster_boris\", \"x\": 6, \"y\": 2, \"room\": \"yard\", \"hostile\": false, \"entity_type\": \"npc\"}], \"npc_focus\": [{\"id\": \"marshal_edda\", \"name\": \"Marshal Edda Vayne\", \"room\": \"courtyard\", \"role\": \"commander\", \"stance\": null, \"hostile\": false}], \"recent_events\": [\"Flag 'planner_lock_auto_lock' enabled.\", \"knowledge adjusted by 1. Cause: planner:investigate.\", \"Flag 'planner_lock_auto_lock' enabled.\", \"knowledge adjusted by 1. Cause: planner:escalate.\", \"Flag 'planner_lock_auto_lock' enabled.\"], \"flags\": [\"planner_lock_auto_lock\"]}\nSTATE_DELTA:\n{\"metrics\": {\"knowledge\": 1}, \"recent_events\": [\"knowledge adjusted by 1. Cause: planner:escalate.\"]}\nSCENE_INTENT:\n{\"focus\": \"escalate\", \"turn\": 7, \"player_choice\": null, \"risk_budget\": 3, \"summary\": \"Turn 7 directive: escalate.\", \"notes\": \"Threat peak (42.1). Event cue: fire_breakout. Endgame directive active.\", \"threat_phase\": \"peak\", \"event_seed\": \"fire_breakout\", \"threat_score\": 42.13, \"final_directive\": {\"final_trigger\": true, \"reason\": \"Reached final graph node: last_defense\", \"recommended_path\": \"desperate\"}}\nRECOMMENDED_FUNCTIONS:\n- apply_combat_pressure(intensity:int) [combat | gas 3] Increase perceived pressure on the defenders.\n- counter_attack(force:str, focus:str) [combat | gas 4] Launch a targeted counter assault.\n- deploy_archers(x:int, y:int, volleys:int?) [combat | gas 3] Position archers to rain arrows at coordinates.\n- fortify_combat_zone(zone:str, armor_boost:int) [combat | gas 4] Improve cover and footing in the named zone.\n- melee_engagement(attacker_ids:npc_id_list, defender_ids:npc_id_list, structure_id:structure_id) [combat | gas 3] Order nearby units into hand-to-hand combat.\nAVAILABLE_FUNCTIONS:\n- apply_combat_pressure(intensity:int) [combat | gas 3] Increase perceived pressure on the defenders.\n- counter_attack(force:str, focus:str) [combat | gas 4] Launch a targeted counter assault.\n- deploy_archers(x:int, y:int, volleys:int?) [combat | gas 3] Position archers to rain arrows at coordinates.\n- fortify_combat_zone(zone:str, armor_boost:int) [combat | gas 4] Improve cover and footing in the named zone.\n- melee_engagement(attacker_ids:npc_id_list, defender_ids:npc_id_list, structure_id:structure_id) [combat | gas 3] Order nearby units into hand-to-hand combat.\n- ranged_attack(target_area:str, intensity:int) [combat | gas 3] Execute a ranged volley on the specified vector.\n- reduce_threat(amount:int) [combat | gas 2] Lower the current threat score through tactics.\n- scout_enemy_positions(npc_id:npc_id, direction:str) [combat | gas 2] Send eyes-on intel about hostile positioning.\n- set_ambush(npc_id:npc_id, x:int, y:int) [combat | gas 4] Hide a unit for an ambush strike.\n- suppressive_fire(sector:str, duration:int) [combat | gas 2] Lay down crossbow or cannon fire to hold enemies.\n- allocate_food(amount:int, target:str) [economy | gas 2] Distribute food stores to a target group.\n- boost_production(workshop:str, focus:str) [economy | gas 3] Focus a workshop on a critical output.\n- check_inventory(resource:str) [economy | gas 1] Report on the level of a resource.\n- craft_ammo(workshop:str, batch:int) [economy | gas 2] Produce ammunition batches in the workshop.\n- gather_supplies(region:str, effort:int) [economy | gas 3] Send teams to gather external resources.\n- limit_consumption(resource:str, percent:int) [economy | gas 1] Cap consumption for a named resource.\n- ration_food(severity:int) [economy | gas 2] Apply rationing to conserve supplies.\n- redistribute_stockpile(from_stock:str, to_stock:str, amount:int) [economy | gas 3] Transfer resources between stockpiles.\n- salvage_material(location:str, amount:int) [economy | gas 2] Salvage debris for reusable materials.\n- store_resources(resource:str, amount:int) [economy | gas 1] Move resources into protected stores.\n- collapse_tunnel(tunnel_id:str) [event | gas 3] Collapse a suspicious tunnel route.\n- create_signal_fire(location:str, intensity:int) [event | gas 2] Light a signal fire at a specified spot.\n- create_storm(duration:int, intensity:int) [event | gas 4] Simulate a storm event around the fortress.\n- extinguish_storm(duration:int) [event | gas 3] Stabilize weather sensors and end storms.\n- flood_area(zone:str, severity:int) [event | gas 3] Flood a zone to slow intruders.\n- reinforce_tunnel(tunnel_id:str, amount:int) [event | gas 2] Stabilize an important tunnel.\n- remove_event_marker(marker_id:str) [event | gas 1] Remove an event marker by id.\n- set_watch_lights(section:str, brightness:int) [event | gas 1] Activate watch lights on the battlements.\n- spawn_event_marker(marker_id:str, x:int, y:int, severity:int?) [event | gas 2] Add a marker to the tactical map.\n- trigger_alarm(level:str, message:str?) [event | gas 2] Raise an alarm level and log it.\n- boost_allied_morale(delta:int) [final_effects | gas 1] Apply a map-wide morale shift for allied forces.\n- collapse_structure(structure_id:structure_id) [final_effects | gas 2] Force a cinematic collapse on the referenced structure.\n- freeze_weather(duration:int) [final_effects | gas 2] Lock the battlefield weather in a frozen state.\n- global_blackout() [final_effects | gas 2] Shut down every light source to create a blackout effect.\n- ignite_structure(structure_id:structure_id) [final_effects | gas 2] Set the structure ablaze for dramatic flair.\n- npc_final_move(npc_id:npc_id, x:int, y:int) [final_effects | gas 1] Move an NPC to a dramatic final coordinate.\n- spawn_fire_effect(x:int, y:int) [final_effects | gas 1] Spawn a large fire marker at map coordinates.\n- spawn_mass_enemy_wave(direction:str, strength:int) [final_effects | gas 3] Telegraph a massed enemy wave from the specified direction.\n- trigger_mass_evacuate() [final_effects | gas 1] Initiate emergency convoys that evacuate remaining civilians.\n- assign_morale_officer(npc_id:npc_id, sector:str) [morale | gas 2] Assign a morale officer to a sector.\n- calm_civilians(zone:str, effort:int) [morale | gas 2] Deploy mediators to calm civilians.\n- celebrate_small_victory(location:str) [morale | gas 1] Mark a win to keep spirits high.\n- comfort_wounded(ward:str, care:int) [morale | gas 2] Provide comfort to wounded units.\n- hold_council_meeting(agenda:str) [morale | gas 2] Gather leaders to discuss morale.\n- hold_speech(topic:str, audience:str) [morale | gas 3] Hold a formal speech at the keep.\n- inspire_troops(speech:str, bonus:int?) [morale | gas 2] Deliver an inspiring field speech.\n- punish_treason(npc_id:npc_id, severity:int) [morale | gas 3] Discipline traitors to deter unrest.\n- reduce_panic(zone:str, amount:int) [morale | gas 2] Apply emergency counseling to reduce panic.\n- reward_bravery(npc_id:npc_id, reward:str) [morale | gas 2] Reward an NPC for valor.\n- assign_role(npc_id:npc_id, role:str) [npc | gas 2] Change the operational role of an NPC.\n- give_equipment(npc_id:npc_id, item:str) [npc | gas 2] Hand new gear to an NPC.\n- heal_npc(npc_id:npc_id, amount:int) [npc | gas 2] Restore health and morale for an NPC.\n- increase_npc_focus(npc_id:npc_id, amount:int) [npc | gas 2] Raise a specialist's focus level.\n- move_npc(npc_id:npc_id, x:int, y:int, room:str?) [npc | gas 2] Reposition an NPC to absolute coordinates.\n- rally_npc(npc_id:npc_id, message:str?) [npc | gas 1] Deliver a quick pep talk to an NPC.\n- reduce_npc_focus(npc_id:npc_id, amount:int) [npc | gas 2] Reduce focus strain for an NPC.\n- rest_npc(npc_id:npc_id, duration:int) [npc | gas 1] Force an NPC to rest for a number of hours.\n- return_from_patrol(npc_id:npc_id, report:str?) [npc | gas 2] Recall an NPC from patrol and log intel.\n- send_on_patrol(npc_id:npc_id, duration:int?) [npc | gas 3] Dispatch an NPC on a patrol route.\n- build_barricade(location:str, materials:int) [structure | gas 3] Assemble makeshift defenses in a corridor.\n- clear_rubble(section_id:str, effort:int) [structure | gas 2] Remove debris blocking access routes.\n- deploy_defense_net(section_id:str, coverage:int) [structure | gas 2] Install nets or chains against climbing.\n- extinguish_fire(structure_id:str, intensity:int) [structure | gas 2] Deal with fires threatening a structure.\n- inspect_wall(section_id:str) [structure | gas 1] Evaluate and log damage at a given wall section.\n- patch_wall_section(section_id:str, amount:int) [structure | gas 2] Apply quick repairs to a wall subsection.\n- reinforce_trench(trench_id:str, amount:int) [structure | gas 2] Deepen or stabilize a trench network.\n- reinforce_wall(structure_id:str, amount:int?, material:str?) [structure | gas 2] Add reinforcement to a wall section.\n- repair_gate(gate_id:str, amount:int) [structure | gas 3] Patch and balance the main gate.\n- strengthen_tower(tower_id:str, amount:int) [structure | gas 3] Boost tower stability and spotting ability.\n- adjust_metric(metric:str, delta:int, cause:str?) [utility | gas 1] Adjust a numeric metric by a delta.\n- clear_flag(flag:str) [utility | gas 1] Remove a world flag when it is no longer needed.\n- log_message(message:str, severity:str?) [utility | gas 1] Append a formatted message to the log.\n- set_flag(flag:str) [utility | gas 1] Enable a world flag for downstream agents.\n- tag_state(tag:str) [utility | gas 1] Attach a monitoring tag to the GameState.\nFEW-SHOT EXAMPLES:\nExample 1 - Reinforce the wall during a storm alert:\n{\"gas\": 1, \"calls\": [{\"name\": \"reinforce_wall\", \"kwargs\": {\"structure_id\": \"western_wall\", \"amount\": 2}}, {\"name\": \"spawn_event_marker\", \"kwargs\": {\"marker_id\": \"storm_watch\", \"x\": 6, \"y\": 1, \"severity\": 2}}]}\nExample 2 - Scout for intel and tighten order:\n{\"gas\": 1, \"calls\": [{\"name\": \"send_on_patrol\", \"kwargs\": {\"npc_id\": \"rhea\", \"duration\": 2}}, {\"name\": \"adjust_metric\", \"kwargs\": {\"metric\": \"order\", \"delta\": 1, \"cause\": \"patrol_visibility\"}}]}\nExample 3 - Stabilize food usage via rationing:\n{\"gas\": 1, \"calls\": [{\"name\": \"allocate_food\", \"kwargs\": {\"amount\": 4, \"target\": \"barracks\"}}, {\"name\": \"log_message\", \"kwargs\": {\"message\": \"Food sent to barracks.\"}}]}\nPLAN_FORMAT:\n{\"gas\": 2, \"calls\": [{\"name\": \"reinforce_wall\", \"kwargs\": {\"structure_id\": \"western_wall\", \"amount\": 2}}, {\"name\": \"set_flag\", \"kwargs\": {\"flag\": \"planner_reserve\"}}]}\nImportant: Only output an object shaped like PLAN_FORMAT. Do not restate PLAN_FORMAT or mention schema fragments.",
    "raw_plan": {
      "gas": 2,
      "calls": [
        {
          "name": "adjust_metric",
          "kwargs": {
            "metric": "knowledge",
            "delta": 1,
            "cause": "planner:escalate"
          }
        },
        {
          "name": "set_flag",
          "kwargs": {
            "flag": "planner_lock_auto_lock"
          }
        }
      ]
    },
    "planned_actions": [
      {
        "function": "adjust_metric",
        "args": {
          "metric": "knowledge",
          "delta": 1,
          "cause": "planner:escalate"
        }
      },
      {
        "function": "set_flag",
        "args": {
          "flag": "planner_lock_auto_lock"
        }
      }
    ]
  },
  "executed_actions": [
    {
      "function": "adjust_metric",
      "args": {
        "metric": "knowledge",
        "delta": 1,
        "cause": "planner:escalate"
      },
      "status": "applied",
      "log": "knowledge adjusted by 1. Cause: planner:escalate.",
      "metrics": {
        "knowledge": 1
      },
      "effects": {
        "knowledge": 55
      }
    },
    {
      "function": "set_flag",
      "args": {
        "flag": "planner_lock_auto_lock"
      },
      "status": "applied",
      "log": "Flag 'planner_lock_auto_lock' enabled.",
      "metrics": {},
      "effects": {
        "flag": "planner_lock_auto_lock"
      }
    }
  ],
  "state_delta": {
    "metrics": {
      "knowledge": 1
    },
    "turn_advanced": true,
    "log_entries": [
      "knowledge adjusted by 1. Cause: planner:escalate.",
      "Flag 'planner_lock_auto_lock' enabled."
    ],
    "npc_positions": {
      "marshal_edda": {
        "x": 4,
        "y": 3,
        "name": "Marshal Edda Vayne",
        "role": "commander",
        "health": 100,
        "morale": 50,
        "fatigue": 7,
        "hostile": false
      },
      "scout_rhea": {
        "x": 2,
        "y": 5,
        "name": "Scout Rhea Emberfall",
        "role": "scout",
        "health": 100,
        "morale": 50,
        "fatigue": 7,
        "hostile": false
      },
      "quartermaster_boris": {
        "x": 6,
        "y": 2,
        "name": "Quartermaster Boris",
        "role": "quartermaster",
        "health": 100,
        "morale": 50,
        "fatigue": 7,
        "hostile": false
      }
    },
    "event_markers": [],
    "wall_integrity": {
      "western_wall": {
        "integrity": 70
      }
    },
    "morale_change": 0,
    "resource_change": 0
  },
  "render_payload": {
    "narrative_block": "Commanders prepare for a final stand around the relic vault. Turn 8 concludes with stability at 62 and resources at 58. Storerooms lose 1 rations to the day's upkeep. Food stores drop by 1 rations. 1. adjust_metric succeeded. 2. set_flag succeeded.",
    "npc_dialogues": [
      {
        "speaker": "Quartermaster Lysa",
        "line": "Stockpiles are running low."
      },
      {
        "speaker": "Watcher Bren",
        "line": "Stability is rising."
      }
    ],
    "atmosphere": {
      "mood": "dire",
      "visuals": "Walls shake, rubble glows with firelight, and embers rain across the courtyard.",
      "audio": "Stone groans, timbers crack, and roaring flames swallow every shout."
    }
  },
  "threat": {
    "base_threat": 32,
    "escalation": 11.91,
    "morale": 62,
    "resources": 58,
    "recent_hostility": 0,
    "turn": 7,
    "threat_score": 42.13,
    "phase": "peak"
  },
  "event_seed": "fire_breakout",
  "final_directive": {
    "final_trigger": true,
    "reason": "Reached final graph node: last_defense",
    "recommended_path": "desperate"
  },
  "event_graph": {
    "current_node": "last_defense",
    "next_node": "last_defense"
  },
  "world_tick": {
    "npc_updates": [
      {
        "id": "marshal_edda",
        "fatigue_delta": 0,
        "morale_delta": 0
      },
      {
        "id": "scout_rhea",
        "fatigue_delta": 1,
        "morale_delta": 0
      },
      {
        "id": "quartermaster_boris",
        "fatigue_delta": 1,
        "morale_delta": 0
      }
    ],
    "structure_updates": [],
    "food_consumed": 1,
    "avg_morale": 50.0,
    "avg_fatigue": 7.0,
    "events": [
      "Food stores drop by 1 rations."
    ]
  },
  "final_result": null
}