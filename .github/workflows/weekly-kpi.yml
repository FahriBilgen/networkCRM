name: Weekly KPI Telemetry

on:
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  telemetry:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
      - name: Run perf watchdog
        env:
          FORTRESS_OFFLINE: "1"
        run: |
          python tools/perf_watchdog.py \
            --turns 3 \
            --random-choice \
            --reset-state \
            --report-dir runs/perf_reports/ci
      - name: Build KPI digest
        run: |
          python tools/kpi_digest.py \
            --report-dir runs/perf_reports/ci \
            --turns 20 \
            --summary-path runs/perf_reports/ci/kpi_summary.md
      - name: Publish KPI summary
        run: cat runs/perf_reports/ci/kpi_summary.md >> "$GITHUB_STEP_SUMMARY"
      - name: Upload KPI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-kpi
          path: runs/perf_reports/ci
