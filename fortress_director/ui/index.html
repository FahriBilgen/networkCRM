<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fortress Director - Control Room</title>
  <style>
    :root {
      color-scheme: dark;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; background: #0f172a; color: #e5e7eb; }
    h1 { font-size: 20px; margin-bottom: 12px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { background: #111827; border: 1px solid #374151; border-radius: 8px; padding: 16px; flex: 1 1 360px; min-width: 320px; }
    button { background: #2563eb; color: white; border: 0; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #374151; }
    button:disabled { background: #1f2937; cursor: not-allowed; }
    ul { margin: 8px 0; padding-left: 20px; }
    li { margin: 6px 0; }
    .options li { cursor: pointer; padding: 6px 8px; border-radius: 4px; border: 1px solid #374151; }
    .options li:hover { background: #1f2937; }
    code { background: #111827; color: #93c5fd; padding: 2px 4px; border-radius: 4px; }
    .small { font-size: 12px; color: #9ca3af; }
    .metric-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .metric-bar { flex: 1; height: 8px; background: #1f2937; border-radius: 999px; overflow: hidden; }
    .metric-bar span { display: block; height: 100%; background: #2563eb; }
    .npc-card { border: 1px solid #374151; border-radius: 6px; padding: 8px; margin-bottom: 6px; }
    .feed { list-style: none; padding-left: 0; max-height: 200px; overflow-y: auto; }
    .feed li { margin-bottom: 6px; border-left: 3px solid #2563eb; padding-left: 8px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
  </style>
  <script>
    let telemetrySource = null;

    async function api(path, opts={}) {
      const res = await fetch(path, { headers: { 'Content-Type': 'application/json' }, ...opts });
      if (!res.ok) throw new Error('Request failed');
      return await res.json();
    }

    function renderMetrics(panel) {
      const box = document.getElementById('metricsPanel');
      if (!panel) {
        box.innerHTML = '<p class="small">No metrics reported.</p>';
        return;
      }
      box.innerHTML = Object.entries(panel)
        .map(([key, val]) => {
          const pct = Math.max(0, Math.min(100, Number(val)));
          return `
            <div class="metric-row">
              <strong style="width:90px;text-transform:capitalize;">${key}</strong>
              <div class="metric-bar"><span style="width:${pct}%"></span></div>
              <span class="small">${val}</span>
            </div>`;
        })
        .join('');
    }

    function renderNPCs(view) {
      const box = document.getElementById('npcCards');
      const trust = (view && view.npc_trust_overview) || [];
      if (!trust.length) {
        box.innerHTML = '<p class="small">No NPC trust data.</p>';
        return;
      }
      box.innerHTML = trust
        .map((npc) => `<div class="npc-card"><strong>${npc.name}</strong><br/><span class="small">Trust: ${npc.trust}</span></div>`)
        .join('');
    }

    function renderGuardrail(view) {
      const feed = document.getElementById('guardrailFeed');
      const notes = (view && view.guardrail_notes) || [];
      if (!notes.length) {
        feed.innerHTML = '<li class="small">No guardrail notes.</li>';
        return;
      }
      feed.innerHTML = notes
        .map((note) => `<li><strong>${note.type}</strong>: ${note.message}</li>`)
        .join('');
    }

    function renderSafeFunctions(view) {
      const feed = document.getElementById('safeFunctionHistory');
      const history = (view && view.safe_function_history) || [];
      if (!history.length) {
        feed.innerHTML = '<li class="small">No safe function calls this turn.</li>';
        return;
      }
      feed.innerHTML = history
        .slice(-6)
        .reverse()
        .map((entry) => `<li><strong>${entry.name}</strong> â€” ${entry.success ? 'ok' : 'failed'}</li>`)
        .join('');
    }

    function renderTelemetry(event) {
      if (!event) return;
      document.getElementById('telemetry').textContent = JSON.stringify(event, null, 2);
    }

    async function refreshState() {
      const state = await api('/game/state');
      document.getElementById('state').textContent = JSON.stringify(state, null, 2);
    }

    async function loadOptions() {
      const data = await api('/game/options');
      const opts = data.options || [];
      const list = document.getElementById('options');
      list.innerHTML = '';
      if (!opts.length) {
        list.innerHTML = '<li class="small">No options available. Try Play Turn.</li>';
      } else {
        opts.forEach((o, idx) => {
          const li = document.createElement('li');
          li.textContent = '['+(idx+1)+'] ' + (o.text || '(no text)') + '  id=' + (o.id || '');
          li.onclick = () => playTurn(o.id);
          list.appendChild(li);
        });
      }
    }

    function updatePlayerView(view) {
      if (!view) return;
      renderMetrics(view.metrics_panel);
      renderNPCs(view);
      renderGuardrail(view);
      renderSafeFunctions(view);
      if (view.map_state) {
        document.getElementById('mapState').textContent = JSON.stringify(view.map_state, null, 2);
      }
    }

    function renderResultRich(result) {
      const box = document.getElementById('resultRich');
      const scene = (result && result.scene) || '';
      const win = (result && result.win_loss) || { status: 'ongoing' };
      const choice = (result && result.player_choice) || {};
      box.innerHTML = `
        <div style="margin-bottom:8px"><strong>Scene</strong><br>${scene || '(no scene)'} </div>
        <div style="margin-top:8px"><strong>Committed Choice</strong>: <code>${choice.id || '(default or random)'}</code> - ${choice.text || ''}</div>
        <div style="margin-top:8px"><strong>Win/Loss</strong>: <code>${win.status}</code> ${win.reason ? '('+win.reason+')' : ''}</div>
      `;
      updatePlayerView(result.player_view);
    }

    async function playTurn(choiceId=null) {
      const result = await api('/game/turn', { method: 'POST', body: JSON.stringify({ choice_id: choiceId }) });
      renderResultRich(result);
      document.getElementById('result').textContent = JSON.stringify(result, null, 2);
      renderTelemetry({ turn: result?.world?.turn, telemetry: result.telemetry, win_loss: result.win_loss });
      await refreshState();
      await loadOptions();
    }

    async function resetGame() {
      await api('/game/reset', { method: 'POST' });
      document.getElementById('result').textContent = '';
      await refreshState();
      await loadOptions();
    }

    function bootTelemetry() {
      if ('EventSource' in window) {
        telemetrySource = new EventSource('/telemetry/events');
        telemetrySource.onmessage = (evt) => {
          try {
            renderTelemetry(JSON.parse(evt.data));
          } catch (err) {
            console.warn('Telemetry parse failed', err);
          }
        };
      } else {
        setInterval(async () => {
          try {
            const payload = await api('/telemetry/latest');
            renderTelemetry(payload.event);
          } catch (err) {
            console.warn('Telemetry poll failed', err);
          }
        }, 10000);
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      await refreshState();
      await loadOptions();
      bootTelemetry();
    });
  </script>
  <base href="/ui/" />
</head>
<body>
  <h1>Fortress Director (Command Panel)</h1>
  <div class="row">
    <div class="card">
      <h2>Controls</h2>
      <button onclick="resetGame()">Reset Game</button>
      <button class="secondary" onclick="loadOptions()">Peek Options</button>
      <button onclick="playTurn(null)">Play Turn (default)</button>
      <button onclick="playTurn('__random__')">Play Turn (random)</button>
      <p class="small">Tip: Click an option below to choose explicitly.</p>
    </div>
    <div class="card">
      <h2>State Snapshot</h2>
      <pre id="state" class="small"></pre>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Options</h2>
      <ul id="options" class="options"></ul>
    </div>
    <div class="card">
      <h2>Last Turn Result</h2>
      <div id="resultRich" class="small"></div>
      <pre id="result" class="small" style="margin-top:8px"></pre>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Metric Panel</h2>
      <div id="metricsPanel" class="small"></div>
    </div>
    <div class="card">
      <h2>NPC Trust</h2>
      <div id="npcCards" class="small"></div>
    </div>
    <div class="card">
      <h2>Map + Rooms</h2>
      <pre id="mapState" class="small"></pre>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Guardrail Feed</h2>
      <ul id="guardrailFeed" class="feed"></ul>
    </div>
    <div class="card">
      <h2>Safe Function History</h2>
      <ul id="safeFunctionHistory" class="feed"></ul>
    </div>
    <div class="card">
      <h2>Telemetry</h2>
      <pre id="telemetry" class="small"></pre>
    </div>
  </div>
</body>
</html>
